Description: >
    This is the main app plus the importer and RabbitMQ service for crowd.loc.gov.

Parameters:
    VPC:
        Description: The VPC that the ECS cluster is deployed to
        Type: AWS::EC2::VPC::Id

    Cluster:
        Description: Please provide the ECS Cluster ID that this service should run on
        Type: String

    DesiredCount:
        Description: How many instances of this task should we run across our cluster?
        Type: Number
        Default: 2

    MaxCount:
        Description: Maximum number of instances of this task we can run across our cluster
        Type: Number
        Default: 3

    Listener:
        Description: The Application Load Balancer listener to register with
        Type: String

    Path:
        Description: The path to register with the Application Load Balancer
        Type: String
        Default: /*

    ECSServiceAutoScalingRoleARN:
        Description: The ECS service auto scaling role ARN
        Type: String

    EnvName:
        Type: String
        Description: dev, test, stage or prod

Resources:
    Service:
        Type: AWS::ECS::Service
        DependsOn: ListenerRule
        Properties:
            Cluster: !Ref Cluster
            Role: !Ref ServiceRole
            DesiredCount: !Ref DesiredCount
            TaskDefinition: !Ref TaskDefinition
            LoadBalancers:
                - ContainerName: 'app'
                  ContainerPort: 80
                  TargetGroupArn: !Ref TargetGroup

    TaskDefinition:
        Type: AWS::ECS::TaskDefinition
        Properties:
            Memory: '2048'
            Cpu: '1024'
            TaskRoleArn: !GetAtt TaskRole.Arn
            Family: !Sub concordia-${EnvName}
            Volumes:
                - Name: images_volume
            ContainerDefinitions:
                - Name: app
                  Essential: true
                  Image: 351149051428.dkr.ecr.us-east-1.amazonaws.com/concordia:latest
                  Links:
                      - rabbit
                  Environment:
                      - Name: AWS
                        Value: '1'
                      - Name: ENV_NAME
                        Value: !Ref EnvName
                      - Name: S3_BUCKET_NAME
                        Value: concordia-staticpages
                      - Name: CELERY_BROKER_URL
                        Value: pyamqp://guest@rabbit:5672
                      - Name: AWS_DEFAULT_REGION
                        Value: !Ref AWS::Region
                      - Name: SENTRY_PUBLIC_DSN
                        Value: http://f69265b381a44ceb89e9bd467f86fbdd@devops-sentry-public-lb-718357739.us-east-1.elb.amazonaws.com/3
                  MountPoints:
                      - SourceVolume: images_volume
                        ContainerPath: /concordia_images
                  PortMappings:
                      - ContainerPort: 80
                        HostPort: 80
                  LogConfiguration:
                      LogDriver: awslogs
                      Options:
                          awslogs-group: !Ref AWS::StackName
                          awslogs-region: !Ref AWS::Region
                          awslogs-stream-prefix: concordia-app-
                - Name: importer
                  Essential: true
                  Image: 351149051428.dkr.ecr.us-east-1.amazonaws.com/concordia/importer:latest
                  Links:
                      - rabbit
                  Environment:
                      - Name: AWS
                        Value: '1'
                      - Name: ENV_NAME
                        Value: !Ref EnvName
                      - Name: S3_BUCKET_NAME
                        Value: concordia-staticpages
                      - Name: CELERY_BROKER_URL
                        Value: pyamqp://guest@rabbit:5672
                      - Name: AWS_DEFAULT_REGION
                        Value: !Ref AWS::Region
                      - Name: SENTRY_PUBLIC_DSN
                        Value: http://f69265b381a44ceb89e9bd467f86fbdd@devops-sentry-public-lb-718357739.us-east-1.elb.amazonaws.com/3
                  MountPoints:
                      - SourceVolume: images_volume
                        ContainerPath: /concordia_images
                  LogConfiguration:
                      LogDriver: awslogs
                      Options:
                          awslogs-group: !Ref AWS::StackName
                          awslogs-region: !Ref AWS::Region
                          awslogs-stream-prefix: concordia-importer-
                - Name: rabbit
                  Essential: true
                  Image: 351149051428.dkr.ecr.us-east-1.amazonaws.com/rabbitmq:latest
                  Hostname: rabbit
                  PortMappings:
                      - ContainerPort: 5672
                        HostPort: 5672

    CloudWatchLogsGroup:
        Type: AWS::Logs::LogGroup
        Properties:
            LogGroupName: !Ref AWS::StackName
            RetentionInDays: 365

    TargetGroup:
        Type: AWS::ElasticLoadBalancingV2::TargetGroup
        Properties:
            VpcId: !Ref VPC
            Port: 80
            Protocol: HTTP
            Matcher:
                HttpCode: 200-299
            HealthCheckIntervalSeconds: 10
            HealthCheckPath: /
            HealthCheckProtocol: HTTP
            HealthCheckTimeoutSeconds: 5
            HealthyThresholdCount: 2

    ListenerRule:
        Type: AWS::ElasticLoadBalancingV2::ListenerRule
        Properties:
            ListenerArn: !Ref Listener
            Priority: 1
            Conditions:
                - Field: path-pattern
                  Values:
                      - !Ref Path
            Actions:
                - TargetGroupArn: !Ref TargetGroup
                  Type: forward

    TaskRole:
        Type: AWS::IAM::Role
        Properties:
            Path: /
            RoleName: !Sub ecs-concordia-taskrole-${AWS::StackName}
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Sid: ''
                      Effect: 'Allow'
                      Principal:
                          Service: 'ecs-tasks.amazonaws.com'
                      Action: 'sts:AssumeRole'
            Policies:
                - PolicyName: !Sub ecs-concordia-taskpolicy-${AWS::StackName}
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Action:
                                - 's3:PutObject'
                                - 's3:GetObject'
                                - 's3:AbortMultipartUpload'
                                - 's3:ListMultipartUploadParts'
                                - 's3:ListBucket'
                                - 's3:ListBucketMultipartUploads'
                                - 'secretsmanager:GetResourcePolicy'
                                - 'secretsmanager:GetSecretValue'
                                - 'secretsmanager:DescribeSecret'
                                - 'secretsmanager:ListSecretVersionIds'
                            Effect: 'Allow'
                            Resource: '*'

    # This IAM Role grants the service access to register/unregister with the
    # Application Load Balancer (ALB). It is based on the default documented here:
    # http://docs.aws.amazon.com/AmazonECS/latest/developerguide/service_IAM_role.html
    ServiceRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: !Sub ecs-concordia-service-${AWS::StackName}
            Path: /
            AssumeRolePolicyDocument:
                Statement:
                    - Effect: 'Allow'
                      Principal:
                          Service:
                              - 'ecs.amazonaws.com'
                      Action:
                          - 'sts:AssumeRole'
            Policies:
                - PolicyName: !Sub ecs-concordia-service-${AWS::StackName}
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Action:
                                - 'ec2:AuthorizeSecurityGroupIngress'
                                - 'ec2:Describe*'
                                - 'elasticloadbalancing:DeregisterInstancesFromLoadBalancer'
                                - 'elasticloadbalancing:Describe*'
                                - 'elasticloadbalancing:RegisterInstancesWithLoadBalancer'
                                - 'elasticloadbalancing:DeregisterTargets'
                                - 'elasticloadbalancing:DescribeTargetGroups'
                                - 'elasticloadbalancing:DescribeTargetHealth'
                                - 'elasticloadbalancing:RegisterTargets'
                            Effect: 'Allow'
                            Resource: '*'

    ServiceScalableTarget:
        Type: 'AWS::ApplicationAutoScaling::ScalableTarget'
        Properties:
            MaxCapacity: !Ref MaxCount
            MinCapacity: !Ref DesiredCount
            ResourceId: !Join
                - /
                - - service
                  - !Ref Cluster
                  - !GetAtt Service.Name
            RoleARN: !Ref ECSServiceAutoScalingRoleARN
            ScalableDimension: ecs:service:DesiredCount
            ServiceNamespace: ecs

    ServiceScaleOutPolicy:
        Type: 'AWS::ApplicationAutoScaling::ScalingPolicy'
        Properties:
            PolicyName: ServiceScaleOutPolicy
            PolicyType: StepScaling
            ScalingTargetId: !Ref ServiceScalableTarget
            StepScalingPolicyConfiguration:
                AdjustmentType: ChangeInCapacity
                Cooldown: 1800
                MetricAggregationType: Average
                StepAdjustments:
                    - MetricIntervalLowerBound: 0
                      ScalingAdjustment: 1

    ServiceScaleInPolicy:
        Type: 'AWS::ApplicationAutoScaling::ScalingPolicy'
        Properties:
            PolicyName: ServiceScaleInPolicy
            PolicyType: StepScaling
            ScalingTargetId: !Ref ServiceScalableTarget
            StepScalingPolicyConfiguration:
                AdjustmentType: ChangeInCapacity
                Cooldown: 1800
                MetricAggregationType: Average
                StepAdjustments:
                    - MetricIntervalUpperBound: 0
                      ScalingAdjustment: -1

    CPUScaleOutAlarm:
        Type: AWS::CloudWatch::Alarm
        Properties:
            AlarmName: !Sub CPU gt 90% ${AWS::StackName}
            AlarmDescription: Alarm if cpu utilization greater than 90% of reserved cpu
            Namespace: AWS/ECS
            MetricName: CPUUtilization
            Dimensions:
                - Name: ClusterName
                  Value: !Ref Cluster
                - Name: ServiceName
                  Value: !GetAtt Service.Name
            Statistic: Maximum
            Period: 60
            EvaluationPeriods: 3
            Threshold: 90
            ComparisonOperator: GreaterThanThreshold
            AlarmActions:
                - !Ref ServiceScaleOutPolicy

    CPUScaleInAlarm:
        Type: AWS::CloudWatch::Alarm
        Properties:
            AlarmName: !Sub CPU lt 70% ${AWS::StackName}
            AlarmDescription: Alarm if cpu utilization greater than 70% of reserved cpu
            Namespace: AWS/ECS
            MetricName: CPUUtilization
            Dimensions:
                - Name: ClusterName
                  Value: !Ref Cluster
                - Name: ServiceName
                  Value: !GetAtt Service.Name
            Statistic: Maximum
            Period: 60
            EvaluationPeriods: 10
            Threshold: 70
            ComparisonOperator: LessThanThreshold
            AlarmActions:
                - !Ref ServiceScaleInPolicy
