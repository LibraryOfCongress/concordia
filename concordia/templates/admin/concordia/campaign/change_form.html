{% extends "admin/change_form.html" %}

{% load i18n admin_urls %}

{% block object-tools-items %}
    {% if original.pk %}
        <li>
            <a href="{% url 'admin:concordia_campaign_export-csv' original.slug %}" class="viewsitelink">
                Export CSV
            </a>
        </li>
        <li>
            <a href="{% url 'admin:concordia_campaign_export-bagit' original.slug %}" class="viewsitelink">
                Export BagIt
            </a>
        </li>
        <li>
            <a href="{% url 'admin:concordia_campaign_report' original.slug %}" class="viewsitelink">
                Report
            </a>
        </li>
        <li>
            <a class="view-related-objects" href="{% url 'admin:concordia_project_changelist' %}?campaign__id__exact={{ original.pk }}">
                Projects
            </a>
        </li>
        <li>
            <a class="view-related-objects" href="{% url 'admin:concordia_item_changelist' %}?project__campaign__id__exact={{ original.pk }}">
                Items
            </a>
        </li>
        <li>
            <a class="view-related-objects" href="{% url 'admin:concordia_asset_changelist' %}?item__project__campaign__id__exact={{ original.pk }}">
                Assets
            </a>
        </li>
    {% endif %}
    {{ block.super }}
{% endblock %}

{% block extrahead %}
    {{ block.super }}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.42.0/codemirror.min.css" integrity="sha256-I8NyGs4wjbMuBSUE40o55W6k6P7tu/7G28/JGUUYCIs=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha256-YLGeXaapI0/5IgZopewRJcFXomhRMlYYjugPLSyNjTY=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.42.0/codemirror.min.js" integrity="sha256-cEZZfu/xNhXjnj1TRr9CrIGoAZ2hztIzwNTUv0Zcll8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@1.15.2/standalone.js" integrity="sha256-J+EGJvtGc2C0TOj2teUqFDcW5ovV2oimUkdea60++qE=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@1.15.2/parser-html.js"  crossorigin="anonymous"></script>
{% endblock extrahead %}

{% block content %}
    {{ block.super }}

    <script>
        (function($) {

            var $bodyRow = $(".field-description");
            $bodyRow.find("label").remove();

            var $bodyPreview = $('<div id="id_description_preview" class="container">');
            $bodyPreview.insertAfter("#id_description");

            var editor = CodeMirror.fromTextArea(document.getElementById("id_description"), {
                mode: "html",
                lineNumbers: true,
                highlightFormatting: true,
                indentUnit: 4,
                lineWrapping: true,
            });

            var queuedUpdate;

            editor.on("change", queueUpdate);

            function queueUpdate() {
                if (queuedUpdate) {
                    window.cancelAnimationFrame(queuedUpdate);
                }
                queuedUpdate = window.requestAnimationFrame(updatePreview);
            }

            function updatePreview() {
                $bodyPreview.empty().html(editor.getValue());
            }

            $('<button class="button">Run Prettier</button>')
                .prependTo(".field-description")
                .on("click", function(evt) {
                    evt.preventDefault();
                    var pretty = prettier.format(editor.getValue(), {
                        parser: "html",
                        plugins: prettierPlugins,
                        printWidth: 120,
                        tabWidth: 4
                    });

                    editor.setValue(pretty);
                    queueUpdate();

                    return false;
                });

            updatePreview();
        })(django.jQuery);
    </script>

    <style>
        .field-description > div {
            display: flex;
            width: 100%;
        }

        .field-description > div > * {
            flex-basis: 50%;
            overflow-y: auto;

            min-height: 500px;
        }
    </style>
{% endblock content %}
